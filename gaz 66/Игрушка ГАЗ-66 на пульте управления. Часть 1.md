<img alt="main" width="700" src="https://habrastorage.org/webt/rz/l8/s0/rzl8s0pnehcut_fbc7adfyu9kvy.jpeg" />

Несколько последних лет хотелось заполучить игрушку на пульте управления и обязательно с видео. Но не купить готовую, а сделать самому. И в итоге заказал себе вот такую игрушку, с простенькой системой управления, но большим потенциалом для модернизации. На все работы от старта и до почти завершения ушло ~ 9 месяцев. Большую часть этого времени ждал комплектующие из Китая.  
Статью пишу по большей части для себя, что бы в дальнейшем не забыть что делал, как, зачем и почему.
Она будет содержать две основные части: аппаратную и программную и возможно еще одну часть про компоновку железа. Сначала опишу аппаратную часть, из чего собирал, с какими проблемами сталкивался и как их решал.

<cut/>

###1. Аппаратная часть

Система состоит из пульта управления и аппаратуры установленной на машинке. Рассмотрим их подробнее. 

####1.1 Пульт управления
Компоненты:

- Raspberry pi 3
- ADS1115 АЦП
- [Game HAT](https://www.waveshare.com/wiki/Game_HAT)

#### Game HAT

Game HAT был выбран т.к. это уже готовое решение совмещающие в себе экран, джойстик и клавиатуру достаточную для управления машинкой.

<img alt="Game HAT" width="400" src="https://habrastorage.org/webt/ku/cy/16/kucy16tjvivlokfhjnm1evobwis.jpeg"/>

Джойстиком на этой плате является KY-023. Его решил использовать вместо руля. Но оказалось, что в Raspberry нет АЦП и единственные значения которые можно было получить от него 0 и 1, что явно недостаточно для плавного поворота колес.

<img alt="KY-023" width="200" src="https://habrastorage.org/webt/kn/qb/oe/knqboerydcnmgjguaidv8ctyycg.jpeg" />

#### ADS1115

Эту проблему решил модуль ADS1115.

<img alt="ADS1115" width="200" src="https://habrastorage.org/webt/_r/8n/f-/_r8nf-9rsvzupsigrs2f7q2k59a.jpeg"/>

Модуль был припаян к Game HAT и прикреплен к ней с помощью ленты 3M. Показания снимаются со средних ножек переменных резисторов на джойстике. Выглядит все так:

<img alt="My Game HAT" width="600" src="https://habrastorage.org/webt/0v/zx/yt/0vzxythizaow9qadldo2mdvma7w.jpeg" />

Джойстик по аналогии впаян в Game HAT. Провода припаяны к разъемам Game HAT, которые соответствуют разъемам питания и I2C на Raspberry. Схема подключения:

<img alt="remote" width="800" src="https://habrastorage.org/webt/x3/7g/nc/x37gnce-kbcv8ec9shm0par52ai.jpeg" />


На этом аппаратный сбор пульта управления закончен. Внешне ни каких видимых изменений он не претерпел.

####1.2 Машинка

Как это все ужасно выглядит под капотом:

<img alt="car" width="800" src="https://habrastorage.org/webt/mi/mw/ii/mimwiiy-4lj44y5ag-lpmp4rfb8.jpeg" />

Начнем разбираться.

Компоненты:

- Raspberry pi 3
- Raspberry Pi Camera v2 NoIR
- PCA9685 ШИМ генератор
- Mini-360 понижающий преобразователь питания
- BMS CF-4S30A-A контролер заряда
- L298N драйвер управления двигателем
- Моя плата управления светом на основе драйвера L293
- 3 литий-ионных батареи 18650 
- 370 мотор 
- DI-1181MG сервопривод

#### Питание

Начнем от питания, его обеспечивают три аккумулятора 18650, соединенных последовательно и дающих ~ 12 вольт. 
Аккумуляторы подсоединены через плату BMS CF-4S30A-A, что бы их можно было заряжать и не разрядить в ноль на покатушках.

<img alt="4S 40A BMS" width="200" src="https://habrastorage.org/webt/xt/q0/_k/xtq0_k_ycvqpeuivas6r8jnbgpw.jpeg" />

Но это плата предназначена для 4-х аккумуляторов, поэтому она была переделана для работы с 3-мя аккумуляторами. Почему была взята она, а не 3S 40A BMS. Потому что она была под рукой.

Схема переделки:

<img alt="4S 40A BMS" width="450" src="https://habrastorage.org/webt/nl/li/-y/nlli-yxzn84k_lmtodkhozqaeog.jpeg" />

Этим напряжением питается 370 мотор через драйвер L298N.

<img alt="370" width="300" src="https://habrastorage.org/webt/s6/9b/of/s69bof6t16zmpse8jn29at93ifa.jpeg" />
<img alt="L298N" width="300" src="https://habrastorage.org/webt/_l/vi/t4/_lvit4ox1-doo6kw8mjpixsvkny.jpeg" />

Для питания Raspberry используются напряжение с этих же аккумуляторов, но напряжение понижается модулем Mini-360 до 5 вольт.

<img alt="mini-360" width="200" src="https://habrastorage.org/webt/ag/zn/ra/agznrap593x3j6t4doyakiukgzo.jpeg" />

Raspberry запитал прямо на его ножки.

#### Движение

Теперь поговорим о том, как машинка ездит. Для управления рулевым механизмом используется сервопривод DI-1181MG, который управляется с помощью PCA9685. Так же PCA9685 отвечает за управление мотором регулируя его скорость и направление вращения через драйвер L298N. Raspberry  же управляет PCA9685 по I2C шине. PCA9685 питается от 5 вольт с понижающего преобразователя. Этого вполне хватает для сервы и управления мотором. Мотор подключен к двум выходам L298N для повышения мощности.

<img alt="DI-1181MG" width="170" src="https://habrastorage.org/webt/km/wm/_b/kmwm_b7oben_iuu1rhyntdu7bru.jpeg" />
<img alt="PCA9685" width="200" src="https://habrastorage.org/webt/zr/3k/k2/zr3kk2nhhqub8p63mmo0ghelcea.jpeg" />

#### Видео

Для видео использовал Camera v2 NoIR, она легко подключается к Raspberry. Но без доработок не обошлось. Стандартный шлейф камеры был в длину 15 см. чего не хватило для монтажных работ. Так же этот шлейф нестандартный, он имеет 15 пинов. На aliexpress за один длинный шлейф для этой камеры китайцы хотят больше 1000 рублей. По этому был куплен комплект из 10 стандартных 16 пиновых шлейфов ~ за 300 рублей. И с помощью высокотехнологичной технологии применения канцелярских ножниц переделан в 15 пиновый шлейф для камеры.

<img alt="camera" width="300" src="https://habrastorage.org/webt/1m/vl/am/1mvlamazfobyscudex2p3xx7d6i.jpeg" />
<img alt="string" width="300" src="https://habrastorage.org/webt/-t/jp/uv/-tjpuv287l5c191kgkjdee_nawm.jpeg" />

На момент написания статьи, 2-ой месяц жду крепление для камеры в кабину. Пока что машинка показывает только потолок )

#### Свет

На машинке уже установлен штатный свет, состоящий из фар с 2-мя желтыми светодиодами. Осталось их только запитать. 
Управление светом осуществляется через мою плату, которая сделана на основе драйвера L293. Питание на диоды подается через резистор. Плата сделана по  технологии ЛУТ. На ней так же куча дорожек для разводки питания.
Можно было бы для управления светом воспользоваться PCA9685, на том момент когда делал свою не знал про PCA9685 и обходился без нее.

Схема платы:

<img alt="my driver" width="500" src="https://habrastorage.org/webt/i0/c1/qx/i0c1qxlmibkwb5yiph3ijkv7d0o.jpeg" />

Представлю общую схему подключения:

<img alt="all" src="https://habrastorage.org/webt/yi/45/63/yi4563ligy60oj5mzjg_-r2xb9k.jpeg" />

А вот это, что стояло в машинке пока я не влез ))

<img alt="old" width="200" src="https://habrastorage.org/webt/zh/i0/k8/zhi0k8fol1yt0e_wlnglzihgcvq.jpeg" />


К моменту написания уже начал забывать, что и как делал. Хотя прошло не больше месяца с момента монтирования.

По аппаратной части все. В следующей свое статье опишу программную часть, как оживлял железо.

### Благодарность
Моим коллегам по работе: Андрею и Николаю за помощь с железом, Антону и Евгению за помощь в работе с видео. Самоделкин-22 за ЛУТ моей платы. И Мурзику.

### Ссылки

[Часть 2](https://habr.com/ru/post/462331/)
[Часть 3](https://habr.com/ru/post/462763/)
